{# -*- coding: utf-8 -*-
  #
  # This file is part of WEKO3.
  # Copyright (C) 2017 National Institute of Informatics.
  #
  # WEKO3 is free software; you can redistribute it
  # and/or modify it under the terms of the GNU General Public License as
  # published by the Free Software Foundation; either version 2 of the
  # License, or (at your option) any later version.
  #
  # WEKO3 is distributed in the hope that it will be
  # useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
  # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
  # General Public License for more details.
  #
  # You should have received a copy of the GNU General Public License
  # along with WEKO3; if not, write to the
  # Free Software Foundation, Inc., 59 Temple Place, Suite 330, Boston,
  # MA 02111-1307, USA.
  #}


{%- extends admin_base_template %}

{%- block css %}
  {{ super() }}
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/react-datepicker/2.4.0/react-datepicker-cssmodules.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/react-datepicker/2.4.0/react-datepicker.min.css">
 {% assets "weko_theme_css_buttons" %}<link href="{{ ASSET_URL }}" rel="stylesheet">{% endassets %}
 <style>
  .mytable tr th,td {
   font-weight : normal;
   height: 40px;
  }
  </style>
{%- endblock css %}

{%- block javascript %}
  {{ super() }}
  <!-- <script src="{{ url_for('static', filename='js/weko_admin/stats_report.js') }}"></script> -->
  {%- assets "weko_admin_stats_report_js" %}<script src="{{ ASSET_URL }}"></script>{% endassets %}
  <script type="text/javascript" src="https://unpkg.com/react@16/umd/react.production.min.js" crossorigin></script>
  <script type="text/javascript" src="https://unpkg.com/react-dom@16/umd/react-dom.production.min.js" crossorigin></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.38/browser.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.7.2/prop-types.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.8.0/js/bootstrap-datepicker.min.js"></script>
  
  
  <script type="text/babel">
    class ComponentTableResult extends React.Component
    {
      constructor(props)
      {
        super(props);
        this.state={
          rows : []
        };
        this.styleTable = {
          "width" : "100%",
        }
      }
      componentDidMount()
      {
        let unit = document.getElementById("unit").value;
        let rows = [];
        let cell = [];
        let data = this.props.data;
        rows.push(<tr>{cell}</tr>);
        if(unit == "Host")
        {
          cell.push(<td>Host</td>);
          cell.push(<td>IP Adress</td>);
          cell.push(<td>Counts</td>);
          for( var i=0; i< data.length;i++)
          {
            cell = [];
            cell.push(<td>{data[i].col1}</td>);
            cell.push(<td>{data[i].col2}</td>);
            cell.push(<td>{data[i].col3}</td>);
            rows.push(<tr>{cell}</tr>);
          }
        }
        else
        {
          cell.push(<td>Period</td>);
          cell.push(<td>Counts</td>);
          for( var i=0; i< data.length;i++)
          {
            cell = [];
            cell.push(<td>{data[i].col1}</td>);
            cell.push(<td>{data[i].col2}</td>);
            rows.push(<tr>{cell}</tr>);
          }
        }
        this.setState({
          rows: rows
        });
      }

      render(){
        return(
          <div style={this.styleContainer} className="form-group row">
            <label className="control-label col-xs-2 text-right" htmlFor={this.props.id_component} style={this.styleLabel}>{this.props.name}</label>
            <div class="controls col-xs-5">
              <br/>
              <table style={this.styleTable} className = "mytable">
                <tbody>
                  {this.state.rows}
                </tbody>
              </table>
            </div>
          </div>
        )
      }
    }

    class ComponentCombobox extends React.Component
    {
      constructor(props)
      {
        super(props);
        this.state = {
          selections: [],
          displayButton: <button className="hidden"></button>,
          responseData: []
        };
        this.required = {
            color: 'red',
        };
        this.handleClickEvent = this.handleClickEvent.bind(this);
      }
      componentDidMount() 
      {
        let initURL = "/api/admin/get_init_selection";
        fetch(initURL)
        .then(res => res.json())
        .then(
          (result) => 
          {
            let selectionData = result[this.props.id_component];
            let options = selectionData.map((option) => {
              return (
                <option key={option.id} value={option.id}>{option.data}</option>
              );
            });
            this.setState({
              selections: options
            });
          }
        );
        let buttonHtml;
        if (this.props.id_component == 'unit') {
          buttonHtml = <button className="btn btn-primary col-xs-1" onClick={this.handleClickEvent}>Display</button>
        }else {
          <button className="hidden"></button>
        }
        this.setState({
          displayButton: buttonHtml
        });
      }

      handleClickEvent(event) {
        let startDate = document.getElementById("start_date").value;
        let endDate = document.getElementById("end_date").value;
        let target = document.getElementById("target").value;
        let unit = document.getElementById("unit").value;

        if (target == 0) {
          alert("Target Report is required!");
        } else if (unit == 0) {
          alert("Unit is required!");
        }else {
          const ITEM_REG_ID = 1;
          if (target == ITEM_REG_ID) {
            let requestParam = {
              start_date: startDate,
              end_date: endDate,
              unit: unit
            };
            let request_url='/api/stats/get_item_registration_report';
            // fetch(request_url, {
            //   method: "GET",
            //   headers: {
            //     "Content-Type": "application/json"
            //   },
            //   body: JSON.stringify(requestParam)
            // })
            // .then(res => res.json())
            // .then(result){
            //   // Handle response data
            // },
          }
        }
      }
      
      render() {
        return (
          <div className="form-group row">
            <label htmlFor={this.props.id_component} className="control-label col-xs-2 text-right">
              {this.props.name}
              <span style={this.required}>
                *
              </span>
            </label>
            <div class="controls col-xs-5">
              <select className="form-control" id={this.props.id_component}>
                <option key="0" value="0">Please select the {this.props.id_component}</option>
                {this.state.selections}
              </select>
            </div>
            {this.state.displayButton}
          </div>
        )
      }
    }

    class ComponentDatePicker extends React.Component
    {
      constructor(props)
      {
        super(props);
        this.styleContainer={
        }
        this.styleLabel = {
          "display" : "inline",
        }
        this.styleDatePicker={
          "border-radius": "3%",
          "background-color":"#fff",
        }
      }

      render(){
        return(
          <div style={this.styleContainer} className="form-group row">
            <label className="control-label col-xs-2 text-right" htmlFor={this.props.id_component} style={this.styleLabel}>{this.props.name}</label>
            <div class="controls col-xs-5">
              <input className="form-control" id={this.props.id_component} style={this.styleDatePicker} readonly="true" type="text"/>
            </div>
          </div>
        )
      }
    }

    class MainLayout extends React.Component 
    {
      constructor(props)
      {
        super(props);
        this.state = {
          result: []
        };
        this.styleContainer = {
          "margin-left": "-14px",
        };
        this.getValueOfField = this.getValueOfField.bind(this);
      }

      getValueOfField(value) {
        switch (key) {
          case 'result':
            this.setState({
              result: value
            });
            break;
        }
      }

      render() {
        return (
          <div class="row content-font">
            <div className="col-md-1">
            </div>
            <div style = {this.styleContainer} className="col-md-11 pull-left">
              <h4 style={this.styleTitle}>Custom Report</h4>
              <ComponentDatePicker name = "Start Date" id_component="start_date"/>
              <ComponentDatePicker name = "End Date" id_component="end_date"/>
              <ComponentCombobox name="Target Report" id_component="target"/>
              <ComponentCombobox name="Unit" getValueOfField={this.getValueOfField} key_binding="result" id_component="unit"/>
              <ComponentTableResult name="Result" data={this.state.result} />
            </div> 
          </div>
        )
    }
    }

    $(function ()
    {
      ReactDOM.render(
      <MainLayout/>,
      document.getElementById('root')
      );
      initDatepicker();
    });

    function initDatepicker(){
      $("#start_date").datepicker({
          format: "yyyy/mm/dd",
          todayBtn: "linked",
          autoclose: true
      });
      $("#end_date").datepicker({
          format: "yyyy/mm/dd",
          todayBtn: "linked",
          autoclose: true
      });
    }
  </script>
{%- endblock javascript %}

{%- block body %}
<style>
  .content-font {
    font-size: 16px;
  }
</style>

<!-- Number of items registered -->
<div class="row content-font">
  <div class="col-md-1"></div>
  <div class="col-md-11 pull-left">
    <h4>{{_('Number of items registered')}}</h4>
  </div>
</div>

<div class="row content-font">
  <div class="col-md-2"></div>
  <div class="col-md-10">
    <label>{{_('Total number of items registered:')}}</label>
    &nbsp;&nbsp;&nbsp;
    {{ result.total if result.total else 0 }}
  </div>
</div>
<div class="row content-font">
  <div class="col-md-2"></div>
  <div class="col-md-10">
    <label>{{_('Number of open items registered:')}}</label>
    &nbsp;&nbsp;&nbsp;
    {{ result.open if result.open else 0 }}
  </div>
</div>
<div class="row content-font">
  <div class="col-md-2"></div>
  <div class="col-md-10">
    <label>{{_('Number of private items registered:')}}</label>
    &nbsp;&nbsp;&nbsp;
    {{ result.private if result.private else 0 }}
  </div>
</div>
<hr>

<div class="row content-font">
  <div class="col-md-1"></div>
  <div class="col-md-11 pull-left">
    <h4>{{_('File Preview Report')}}</h4>
  </div>
</div>

<div class="row content-font">
  <div class="col-md-2"></div>
  <div class="col-md-4">
    <label>{{_('Aggregation month')}}</label>
  </div>
</div>

<div class="row content-font">
  <div class="col-md-2"></div>
  <form method="POST" name="report_file_form" id="report_file_form"
    action={{url_for('report.get_file_stats_tsv')}}>
    <p class="col-md-1 text-right">{{_('Type')}}</p>
    <div class="col-md-2">
      <select class="form-control" id="report_type_select" name="type">
        <option value="all" selected>{{_('All')}}</option>
        <option value="file_download">{{ _("File Downloads") }}</option>
        <option value="file_preview">{{ _("File Previews") }}</option>
      </select>
    </div>

    <p class="col-md-1 text-right">{{_('Year')}}</p>
    <div class="col-md-1">
      <select class="form-control" id="report_year_select" name="year">
        <option selected>{{_('Year')}}</option>
        {% for x in range(5) %}
          {% set year = now.year - x %}
          <option value="{{ year }}">{{ year }}</option>
        {% endfor %}
      </select>
    </div>

    <p class="col-md-1 text-right">{{_('Month')}}</p>
    <div class="col-md-1">
      <select class="form-control" id="report_month_select" name="month">
        <option selected>{{_('Month')}}</option>
        <option value="1">{{_('01')}}</option>
        <option value="2">{{_('02')}}</option>
        <option value="3">{{_('03')}}</option>
        <option value="4">{{_('04')}}</option>
        <option value="5">{{_('05')}}</option>
        <option value="6">{{_('06')}}</option>
        <option value="7">{{_('07')}}</option>
        <option value="8">{{_('08')}}</option>
        <option value="9">{{_('09')}}</option>
        <option value="10">{{_('10')}}</option>
        <option value="11">{{_('11')}}</option>
        <option value="12">{{_('12')}}</option>
      </select>
    </div>
    <input type="hidden" id="report_file_input" name="report" value="{}" />
  </form>
  <div class="col-md-2">
    <button id="downloadReport" class="btn btn-primary action-big-button">
          <span class="glyphicon glyphicon-download-alt"></span>
                {{_('Download')}}</button>
  </div>
</div>
<hr>

<div id="root" class="col-xs-12"></div>

<div class="modal fade" tabindex="-1" role="dialog" id="error_modal">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">{{_('Error')}}</h4>
      </div>
      <div class="modal-body">
        <p class="text-center">{{_('Could not download file.')}}</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-info close-button" data-dismiss="modal">
              <span class="glyphicon glyphicon-remove"></span>
                 {{_('Close')}}
        </button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

{%- endblock body %}

